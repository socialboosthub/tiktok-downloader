<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TikTok Profile Downloader</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 20px;
}

.card {
  max-width: 500px;
  margin: auto;
  background: white;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 10px;
}

.username {
  font-weight: bold;
  font-size: 18px;
}

.nickname {
  color: gray;
  margin-bottom: 20px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
}

.thumb {
  width: 100%;
  border-radius: 8px;
  cursor: pointer;
}

.loading {
  text-align: center;
  padding: 40px;
}
</style>
</head>

<body>

<div class="card">
  <div id="loading" class="loading">Loading profileâ€¦</div>

  <img id="avatar" class="avatar" style="display:none">
  <div id="username" class="username"></div>
  <div id="nickname" class="nickname"></div>

  <div id="videos" class="grid"></div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
let input = params.get("links");

// ðŸ”´ FIX: extract username from URL
function extractUsername(text) {
  if (!text) return null;
  text = text.trim();

  if (text.includes("tiktok.com")) {
    let parts = text.split("/");
    return parts.pop().replace("@", "") || parts.pop();
  }
  return text.replace("@", "");
}

const username = extractUsername(input);

if (!username) {
  alert("Invalid profile link");
  throw new Error("No username");
}

fetch(`/profile?username=${username}`)
  .then(res => res.json())
  .then(data => {
    document.getElementById("loading").style.display = "none";

    document.getElementById("avatar").src = data.avatar;
    document.getElementById("avatar").style.display = "block";

    document.getElementById("username").textContent = "@" + data.username;
    document.getElementById("nickname").textContent = data.nickname;

    const grid = document.getElementById("videos");

    data.videos.forEach(v => {
      const img = document.createElement("img");
      img.src = v.cover;
      img.className = "thumb";
      img.onclick = () => {
        window.location.href = "/download?url=" + encodeURIComponent(v.play);
      };
      grid.appendChild(img);
    });
  })
  .catch(() => {
    alert("Failed to load profile");
  });
</script>

</body>
</html>
