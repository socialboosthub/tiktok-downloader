<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Slideshow Gallery</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #010101;
  color: #fff;
  margin: 0;
  padding: 15px;
  text-align: center;
}

.main-container {
  max-width: 480px;
  margin: auto;
}

/* DOWNLOAD ALL BUTTON */
.all-btn {
  width: 100%;
  padding: 16px;
  border-radius: 12px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  background: #fff;
  color: #000;
  margin-bottom: 16px;
}

/* HORIZONTAL SLIDER */
#gallery {
  display: flex;
  gap: 14px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
}

#gallery::-webkit-scrollbar {
  display: none;
}

/* SLIDE */
.photo-card {
  background: #121212;
  border: 1px solid #222;
  border-radius: 20px;
  padding: 12px;
  min-width: 100%;
  flex-shrink: 0;
  scroll-snap-align: center;
}

.slider-img {
  width: 480px;
  border-radius: 14px;
  margin-bottom: 12px;
  height: 240px;
  object-fit: contain;
}

/* BUTTON */
.download-btn {
  width: 480px;
  padding: 16px;
  border-radius: 12px;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

.individual-btn {
  background: linear-gradient(45deg, #EE1D52, #25F4EE);
  color: #fff;
}

/* LOADER */
#loader-box {
  margin-top: 100px;
}
</style>
</head>

<body>
<div class="main-container">

  <div id="loader-box">
    <p>FETCHING SLIDESHOW...</p>
  </div>

  <!-- ✅ BUTTON MUST BE OUTSIDE SLIDER -->
  <button class="all-btn" id="dl-all-btn" style="display:none;">
    DOWNLOAD ALL IMAGES
  </button>

  <!-- ✅ SLIDER ONLY CONTAINS SLIDES -->
  <div id="gallery" style="display:none;"></div>

</div>

<script>
const downloadedFiles = new Set();

async function loadSlideshow() {
  const links = new URLSearchParams(window.location.search).get("links");
  if (!links) return;

  const res = await fetch(`/api?url=${encodeURIComponent(links)}`);
  const json = await res.json();
  const data = json.data;

  if (!data || !data.images) return;

  const gallery = document.getElementById("gallery");
  const allBtn = document.getElementById("dl-all-btn");

  function downloadImage(imgUrl, fileName) {
    if (downloadedFiles.has(fileName)) {
      if (!confirm(`${fileName} already downloaded.\n\nDownload again?`)) return;
    }

    downloadedFiles.add(fileName);

    const a = document.createElement("a");
    a.href = `/image?url=${encodeURIComponent(imgUrl)}&name=${fileName.replace(".jpg","")}`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // DOWNLOAD ALL
  allBtn.onclick = async () => {
    for (let i = 0; i < data.images.length; i++) {
      const fileName = `Tiksave_${data.id}_${i + 1}.jpg`;
      downloadImage(data.images[i], fileName);
      await new Promise(r => setTimeout(r, 1200));
    }
  };

  // INDIVIDUAL SLIDES
  data.images.forEach((img, i) => {
    const fileName = `Tiksave_${data.id}_${i + 1}.jpg`;

    const card = document.createElement("div");
    card.className = "photo-card";
    card.innerHTML = `
      <img src="${img}" class="slider-img">
      <button class="download-btn individual-btn">
        DOWNLOAD PHOTO ${i + 1}
      </button>
    `;

    card.querySelector("button").onclick = () => {
      downloadImage(img, fileName);
    };

    gallery.appendChild(card);
  });

  document.getElementById("loader-box").style.display = "none";
  gallery.style.display = "flex";
  allBtn.style.display = "block";
}

loadSlideshow();
</script>
</body>
</html>
