<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Slideshow Gallery Download</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #f4f4f4;
    padding: 12px;
    text-align: center;
    margin: 0;
  }

  .main-container {
    max-width: 450px;
    margin: 0 auto;
  }

  /* Each Image + Button pair is a "photo-card" */
  .photo-card {
    background: #fff;
    margin: 20px 0;
    padding: 15px;
    border-radius: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    text-align: left;
  }

  .slider-img {
    width: 100%;
    height: auto; /* Show full image aspect ratio */
    max-height: 500px;
    border-radius: 10px;
    object-fit: contain;
    background: #eee;
    display: block;
  }

  .download-btn {
    margin-top: 12px;
    padding: 14px;
    width: 100%;
    border: none;
    border-radius: 10px;
    background: #000;
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
  }

  .info-header {
    background: #fff;
    padding: 15px;
    border-radius: 14px;
    margin-bottom: 20px;
    text-align: left;
    display: flex;
    align-items: center;
  }

  .avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 12px;
  }

  .username {
    font-weight: 700;
    font-size: 16px;
  }

  .caption {
    font-size: 14px;
    color: #444;
    margin: 10px 5px;
    text-align: left;
  }
</style>
</head>
<body>

<div class="main-container">
  <h3>Slideshow Gallery</h3>
  <div id="gallery"></div>
</div>

<script>
const params = new URLSearchParams(location.search);
const rawLinks = params.get("links");

if (!rawLinks) {
  document.body.innerHTML = "<h3>No links provided</h3>";
  throw new Error("No links");
}

const links = rawLinks.split("\n").map(l => l.trim()).filter(Boolean);
const gallery = document.getElementById("gallery");

async function loadSliders() {
  for (const link of links) {
    try {
      const res = await fetch(`/api?url=${encodeURIComponent(link)}`);
      const json = await res.json();
      const data = json.data;

      if (!data?.images) continue;

      const videoId = data.id || Date.now();
      
      // 1. Create Header for this TikTok (Avatar & Username)
      const header = document.createElement("div");
      header.className = "info-header";
      header.innerHTML = `
        <img class="avatar" src="${data.author.avatar}">
        <div>
          <div class="username">@${data.author.unique_id}</div>
          <div style="font-size:12px; color:gray;">${data.images.length} photos found</div>
        </div>
      `;
      gallery.appendChild(header);

      if(data.title) {
        const cap = document.createElement("div");
        cap.className = "caption";
        cap.textContent = data.title;
        gallery.appendChild(cap);
      }

      // 2. Loop through every image and create a card for EACH one
      data.images.forEach((imgUrl, i) => {
        const photoCard = document.createElement("div");
        photoCard.className = "photo-card";
        
        // Image element
        const img = document.createElement("img");
        img.className = "slider-img";
        img.src = imgUrl;

        // Individual Download Button
        const btn = document.createElement("button");
        btn.className = "download-btn";
        btn.textContent = `Download Photo ${i + 1}`;
        
        const fileName = `tiktok_${videoId}_${i + 1}`;
        btn.onclick = () => {
          window.location.href = `/image?url=${encodeURIComponent(imgUrl)}&name=${fileName}`;
        };

        photoCard.appendChild(img);
        photoCard.appendChild(btn);
        gallery.appendChild(photoCard);
      });

      // Separation line if multiple links are processed
      const hr = document.createElement("hr");
      hr.style.margin = "40px 0";
      hr.style.opacity = "0.2";
      gallery.appendChild(hr);

    } catch (err) {
      console.error("Failed to load:", err);
    }
  }
}

loadSliders();
</script>

</body>
</html>
