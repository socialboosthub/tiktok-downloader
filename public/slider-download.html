<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Slideshow Gallery</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: system-ui, sans-serif; background: #010101; color: #fff; padding: 15px; text-align: center; margin: 0; overflow-x: hidden; }
  .main-container { max-width: 480px; margin: 0 auto; }
  
  /* Horizontal Slider Styles */
  #gallery { 
    display: flex; 
    overflow-x: auto; 
    scroll-snap-type: x mandatory; 
    gap: 15px; 
    padding: 10px 0 20px 0;
    scrollbar-width: none; 
    -webkit-overflow-scrolling: touch;
  }
  #gallery::-webkit-scrollbar { display: none; }

  .photo-card { 
    background: #121212; 
    border: 1px solid #222; 
    border-radius: 20px; 
    padding: 12px; 
    flex: 0 0 85%; /* Sized so the next card is slightly visible */
    scroll-snap-align: center;
    box-sizing: border-box;
  }

  .slider-img { width: 100%; border-radius: 14px; margin-bottom: 12px; height: auto; display: block; }
  
  .download-btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; }
  .individual-btn { background: linear-gradient(45deg, #EE1D52, #25F4EE); }
  .all-btn { background: white; color: black; margin: 0 auto 20px auto; font-size: 16px; display: block; width: 100%; }

  /* Loader */
  #loader-box { margin-top: 100px; display: flex; flex-direction: column; align-items: center; }
  .tiktok-spinner { position: relative; width: 60px; height: 60px; margin-bottom: 20px; }
  .tiktok-spinner div { position: absolute; width: 100%; height: 100%; border-radius: 50%; opacity: 0.8; mix-blend-mode: screen; }
  .cyan { background-color: #25F4EE; animation: move-cyan 1.5s infinite ease-in-out; }
  .pink { background-color: #EE1D52; animation: move-pink 1.5s infinite ease-in-out; animation-delay: -0.75s; }
  @keyframes move-cyan { 0%, 100% { transform: translateX(-20px); } 50% { transform: translateX(20px); } }
  @keyframes move-pink { 0%, 100% { transform: translateX(20px); } 50% { transform: translateX(-20px); } }
</style>
</head>
<body>

<div class="main-container">
  <div id="loader-box">
    <div class="tiktok-spinner"><div class="cyan"></div><div class="pink"></div></div>
    <p>FETCHING SLIDESHOW...</p>
  </div>

  <button class="download-btn all-btn" id="dl-all-btn" style="display:none">DOWNLOAD ALL IMAGES</button>
  
  <div id="gallery" style="display:none"></div>
</div>

<script>
// Function to handle the actual file download
async function downloadFile(url, filename) {
  try {
    const response = await fetch(url);
    const blob = await response.blob();
    const blobUrl = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = blobUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(blobUrl);
  } catch (err) {
    // Fallback if blob fetch fails
    window.location.href = url;
  }
}

async function load() {
  const links = new URLSearchParams(window.location.search).get("links");
  if (!links) return;

  try {
    const res = await fetch(`/api?url=${encodeURIComponent(links)}`);
    const json = await res.json();
    const data = json.data;

    if (!data?.images) return;

    const gallery = document.getElementById("gallery");
    const dlAllBtn = document.getElementById('dl-all-btn');
    
    // Download All logic
    dlAllBtn.onclick = async () => {
      for (let i = 0; i < data.images.length; i++) {
        const fileName = `tiktok_${data.id}_${i+1}.jpg`;
        const downloadUrl = `/image?url=${encodeURIComponent(data.images[i])}&name=tiktok_${data.id}_${i+1}`;
        await downloadFile(downloadUrl, fileName);
        await new Promise(r => setTimeout(r, 800)); // Short delay
      }
    };

    data.images.forEach((img, i) => {
      const card = document.createElement("div");
      card.className = "photo-card";
      
      const fileName = `tiktok_${data.id}_${i+1}.jpg`;
      const downloadUrl = `/image?url=${encodeURIComponent(img)}&name=tiktok_${data.id}_${i+1}`;
      
      card.innerHTML = `
        <img class="slider-img" src="${img}">
        <button class="download-btn individual-btn" id="btn-${i}">
          DOWNLOAD PHOTO ${i+1}
        </button>
      `;
      gallery.appendChild(card);
      
      // Individual button click listener
      document.getElementById(`btn-${i}`).onclick = () => downloadFile(downloadUrl, fileName);
    });

    document.getElementById("loader-box").style.display = "none";
    dlAllBtn.style.display = "block";
    gallery.style.display = "flex";
  } catch (err) { }
}
load();
</script>
</body>
</html>
