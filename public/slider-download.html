<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Slideshow Gallery</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #010101;
  color: #fff;
  margin: 0;
  padding: 15px;
  text-align: center;
}
.main-container { max-width: 480px; margin: auto; }
.photo-card {
  background: #121212;
  border: 1px solid #222;
  border-radius: 20px;
  padding: 12px;
  margin-bottom: 20px;
}
.slider-img { width: 100%; border-radius: 14px; margin-bottom: 12px; }
.download-btn {
  width: 100%;
  padding: 16px;
  border-radius: 12px;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
.individual-btn {
  background: linear-gradient(45deg, #EE1D52, #25F4EE);
  color: #fff;
}
.all-btn {
  background: #fff;
  color: #000;
  margin-bottom: 20px;
}
#loader-box {
  margin-top: 100px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
</style>
</head>

<body>
<div class="main-container">

  <div id="loader-box">
    <p>FETCHING SLIDESHOW...</p>
  </div>

  <div id="gallery" style="display:none;">
    <button class="download-btn all-btn" id="dl-all-btn">
      DOWNLOAD ALL IMAGES
    </button>
  </div>

</div>

<script>
const downloadedFiles = new Set();

async function loadSlideshow() {
  const links = new URLSearchParams(window.location.search).get("links");
  if (!links) return;

  const res = await fetch(`/api?url=${encodeURIComponent(links)}`);
  const json = await res.json();
  const data = json.data;
  if (!data || !data.images) return;

  const gallery = document.getElementById("gallery");

  function downloadImage(imgUrl, fileName) {
    if (downloadedFiles.has(fileName)) {
      const again = confirm(
        `${fileName} already downloaded.\n\nDownload again?`
      );
      if (!again) return;
    }

    downloadedFiles.add(fileName);

    const a = document.createElement("a");
    a.href = `/image?url=${encodeURIComponent(imgUrl)}&name=${fileName}`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // DOWNLOAD ALL
  document.getElementById("dl-all-btn").onclick = async () => {
    for (let i = 0; i < data.images.length; i++) {
      const fileName = `Tiksave_${data.id}_${i + 1}.jpg`;
      downloadImage(data.images[i], fileName);
      await new Promise(r => setTimeout(r, 1200));
    }
  };

  // INDIVIDUAL
  data.images.forEach((img, i) => {
    const fileName = `Tiksave_${data.id}_${i + 1}.jpg`;

    const card = document.createElement("div");
    card.className = "photo-card";
    card.innerHTML = `
      <img src="${img}" class="slider-img">
      <button class="download-btn individual-btn">
        DOWNLOAD PHOTO ${i + 1}
      </button>
    `;

    card.querySelector("button").onclick = () => {
      downloadImage(img, fileName);
    };

    gallery.appendChild(card);
  });

  document.getElementById("loader-box").style.display = "none";
  gallery.style.display = "block";
}

loadSlideshow();
</script>
</body>
</html>
