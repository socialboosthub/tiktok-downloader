<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Preparing Slider Download</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: system-ui, sans-serif; background: #f4f4f4; padding: 12px; text-align: center; }
  .card { background: #fff; max-width: 420px; margin: 20px auto; padding: 15px; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.08); text-align: left; }
  .thumb { width: 100%; height: 240px; border-radius: 12px; background: #ddd; object-fit: cover; }
  .user { display: flex; align-items: center; margin-top: 12px; }
  .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; background: #ddd; }
  .username { font-weight: 600; }
  .caption { font-size: 13px; color: #555; margin-top: 6px; }
  .status { font-size: 13px; color: #777; margin-top: 10px; }
  button { margin-top: 14px; padding: 14px; width: 100%; border: none; border-radius: 10px; background: #000; color: #fff; font-size: 15px; cursor: pointer; }
  button:disabled { background: #666; cursor: not-allowed; }
</style>
</head>
<body>

<h3>Preparing Slider Download…</h3>
<div id="list"></div>

<script>
const params = new URLSearchParams(location.search);
const rawLinks = params.get("links");

if (!rawLinks) {
  document.body.innerHTML = "<h3>No links provided</h3>";
  throw new Error("No links");
}

const links = rawLinks.split("\n").map(l => l.trim()).filter(Boolean);
const list = document.getElementById("list");

links.forEach(async (link, index) => {
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `
    <img class="thumb">
    <div class="user">
      <img class="avatar">
      <div class="username">Loading…</div>
    </div>
    <div class="caption"></div>
    <div class="status">Fetching slider ${index + 1}…</div>
  `;
  list.appendChild(card);

  const thumb = card.querySelector(".thumb");
  const avatar = card.querySelector(".avatar");
  const usernameEl = card.querySelector(".username");
  const captionEl = card.querySelector(".caption");
  const status = card.querySelector(".status");

  try {
    // We fetch from /api first to get the ID, just like the video downloader
    const res = await fetch(`/api?url=${encodeURIComponent(link)}`);
    const json = await res.json();
    const data = json.data;

    if (!data?.images || data.images.length === 0) {
      status.textContent = "Not a slider post (Video detected)";
      return;
    }

    // UNIQUE ID LOGIC (Same as your video code)
    const videoId = data.id || Date.now();

    thumb.src = data.images[0];
    avatar.src = data.author?.avatar || "";
    usernameEl.textContent = "@" + (data.author?.unique_id || "user");
    captionEl.textContent = data.title || "No caption";

    const btn = document.createElement("button");
    btn.textContent = data.images.length === 1 ? "Download Photo" : `Download ${data.images.length} Photos`;

    btn.onclick = async () => {
      btn.disabled = true;
      status.textContent = "Downloading images...";

      for (let i = 0; i < data.images.length; i++) {
        const a = document.createElement("a");
        // Using unique tiktok_ID_1.jpg naming format
        const fileName = `tiktok_${videoId}_${i + 1}`;
        a.href = `/image?url=${encodeURIComponent(data.images[i])}&name=${fileName}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        // Small delay to prevent browser from blocking multiple downloads
        await new Promise(r => setTimeout(r, 1000));
        status.textContent = `Downloaded ${i + 1}/${data.images.length}`;
      }

      status.textContent = "All photos downloaded!";
      btn.disabled = false;
    };

    card.appendChild(btn);
    status.textContent = "Ready";

  } catch (err) {
    status.textContent = "Failed to load slider";
    console.error(err);
  }
});
</script>
</body>
</html>
